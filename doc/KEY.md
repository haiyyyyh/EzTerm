# 关于EzTerm的键盘事件处理逻辑

## 核心原则

果断砍掉对某些冷门和系统级快捷键的支持，他们大多是不常被使用、受环境影响大导致不可预测，亦或被系统捕获，适配无意义  
这是保证EzTerm轻量、简洁做出的决策，也防止使用EzTerm的程序出现可移植性极差和快捷键体系混乱的问题  
总的来说，使用者们会意识到某些快捷键不应被使用，如果有需要请自行定义  

## 对于键盘按键的分类和定义

### 键盘的可打印字符区
> 包含字母键、数字键、符号键，和'\n','\b'

### 功能键
> `F1`～`F12`，以及`pgup`、`pgdn`、`ins`、`del`、`home`、`end`，还有方向键
- 都有对应的转义序列
- 这些键都是以ESC为前缀的功能按键，如下表

|按键|对应序列|
|------|--------|
|`F1`  |\033[OP |
|`F2`  |\033[OQ |
|`F3`  |\033[OR |
|`F4`  |\033[OS |
|`F5`  |\033[15~|
|`F6`  |\033[17~|
|`F7`  |\033[18~|
|`F8`  |\033[19~|
|`F9`  |\033[20~|
|`F10` |\033[21~|
|`F11` |\033[23~|
|`F12` |\033[24~|
|`ins` |\033[2~ |
|`del` |\033[3~ |
|`pgup`|\033[5~ |
|`pgdn`|\033[6~ |
|`home`|\033[H  |
|`end` |\033[F  |
|`↑`   |\033[A  |
|`↓`   |\033[B  |
|`→ `  |\033[C  |
|`← `  |\033[D  |

不过要知道，F11键基本都会被终端模拟器捕获，但是其确有着明确的定义

### 修饰按键与字母键的组合
> 修饰按键包括`Ctrl`、`Alt`、`Shift`

首先，我们先要搞清楚这些键本质是什么  

这些键其实都有着明确的定义，将他们组合在一起基本会得到能预测的效果  

`Alt`  ：本质是在键的序列前加上一个ESC，表现为当按下`a`会得到 'a' ，按下`Alt`-`a`会得到 '\033a' ，而 '\033' 就是`ESC`键的序列，这一点对于可打印区的所有键都生效  
`SHIFT`：有翻转意，会对按键进行大小写翻转/输入字符翻转，`Shift`-`a`=='A'，`Shift`-`;`==':'  
`Ctrl` ：一说为control，本质上是会将按下的26字母键 映射到ascii表中的控制字符区域，通过组合键实现控制字符输出, 这有必要好好说说  

#### Ctrl
我们来看这样一个宏  
```cpp
#define CTRL(x) ((x) & 037)
```
来自*termios* 头文件，是UNIX家族的祖传逻辑  
这里的位与运算，会将x代表的某个键的ascii码与037这个八进制数字进行位与  
而037的二进制是00011111，意味着x键将被消去高三位  
注意，037是ascii编码表 前面控制字符区域的最后一个控制字符，也就是说控制字符的二进制数据实际信息只有5bit  
这就意味着他的映射机制是砍掉按键编码的高三位，得到映射到功能区的键值  
所以要当心，`Ctrl`修饰的两个不同按键按键，值有可能是一样的  

#### 特殊情况

- `Tab`键
    - `Shift`+`Tab`有明确定义，序列是'\033[Z'
    - `Ctrl`+`Tab`和`Shift`+`Tab`无效
    - `Alt`+`Tab`常会被系统截获，不作处理


### 修饰按键与功能键组合

这和与字母组合又不一样了  
每个修饰按键都会有自己的一个数字，我暂且叫它修饰编号：

- `Shift` : 2
- `Alt` : 3
- `Alt`-`Shift` : 4
- `Ctrl` : 5
- `Ctrl`-`Alt` : 7
- `Ctrl`-`Alt`-`Shift` : 8
- `Alt`-`Ctrl` : 
    > 这和顺序无关，等同于`Ctrl`-`Alt`
- `Ctrl`-`Shift` : 
    - 大部分会无效，按出*空*，有的还可能被系统截获
    - 此组合算作无效，将不被支持


接下来讲一下修饰编号的作用，下文中用#符号代表修饰编号  

|按键|对应序列|   修饰后  |
|----|--------|-----------|
|`F1`  |\033[OP |\033[1;#P  |
|`F2`  |\033[OQ |\033[1;#Q  |
|`F3`  |\033[OR |\033[1;#R  |
|`F4`  |\033[OS |\033[1;#S  |
|`F5`  |\033[15~|\033[15;#~ |
|`F6`  |\033[17~|\033[17;#~ |
|`F7`  |\033[18~|\033[18;#~ |
|`F8`  |\033[19~|\033[19;#~ |
|`F9`  |\033[20~|\033[20;#~ |
|`F10` |\033[21~|\033[21;#~ |
|`F11` |\033[23~|\033[23;#~ |
|`F12` |\033[24~|\033[24;#~ |
|`ins` |\033[2~ |\033[2;#~  |
|`del` |\033[3~ |\033[3;#~  |
|`pgup`|\033[5~ |\033[5;#~  |
|`pgdn`|\033[6~ |\033[6;#~  |
|`home`|\033[H  |\033[1;#H  |
|`end` |\033[F  |\033[1;#F  |
|`↑`   |\033[A  |\033[1;$A  |
|`↓`   |\033[B  |\033[1;$B  |
|`→ `  |\033[C  |\033[1;$C  |
|`← `  |\033[D  |\033[1;$D  |

由此可见，对于数字编号的功能键，会在数字与'~'间加上';#'后缀  
而含有字母编号的功能键则会在字母前面加上'1;#'前缀
